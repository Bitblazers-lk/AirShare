#pragma checksum "D:\My Projects\C# Git\AirShare\Controls\Explorer.razor" "{ff1816ec-aa5e-4d10-87f7-6f4963833460}" "36c5a2c82032080ff1326321895cbe01be920ac7"
// <auto-generated/>
#pragma warning disable 1591
#pragma warning disable 0414
#pragma warning disable 0649
#pragma warning disable 0169

namespace AirShare.Controls
{
    #line hidden
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using Microsoft.AspNetCore.Components;
#nullable restore
#line 1 "D:\My Projects\C# Git\AirShare\_Imports.razor"
using System.Net.Http;

#line default
#line hidden
#nullable disable
#nullable restore
#line 2 "D:\My Projects\C# Git\AirShare\_Imports.razor"
using Microsoft.AspNetCore.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "D:\My Projects\C# Git\AirShare\_Imports.razor"
using Microsoft.AspNetCore.Components.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "D:\My Projects\C# Git\AirShare\_Imports.razor"
using Microsoft.AspNetCore.Components.Forms;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "D:\My Projects\C# Git\AirShare\_Imports.razor"
using Microsoft.AspNetCore.Components.Routing;

#line default
#line hidden
#nullable disable
#nullable restore
#line 6 "D:\My Projects\C# Git\AirShare\_Imports.razor"
using Microsoft.AspNetCore.Components.Web;

#line default
#line hidden
#nullable disable
#nullable restore
#line 7 "D:\My Projects\C# Git\AirShare\_Imports.razor"
using Microsoft.JSInterop;

#line default
#line hidden
#nullable disable
#nullable restore
#line 9 "D:\My Projects\C# Git\AirShare\_Imports.razor"
using AirShare.Shared;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "D:\My Projects\C# Git\AirShare\Controls\Explorer.razor"
using AirShare;

#line default
#line hidden
#nullable disable
    [Microsoft.AspNetCore.Components.RouteAttribute("/explorer")]
    public partial class Explorer : Microsoft.AspNetCore.Components.ComponentBase
    {
        #pragma warning disable 1998
        protected override void BuildRenderTree(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder __builder)
        {
        }
        #pragma warning restore 1998
#nullable restore
#line 60 "D:\My Projects\C# Git\AirShare\Controls\Explorer.razor"
      

    User usr {get;set;}
    bool authed {get;set;}
    bool Failed {get;set;}
    string msg {get;set;}

    [Parameter]
    public string Path {get;set;}

    DirectoryEntries DE;

    
    protected override void OnInitialized()
    {
   
        Failed = false;

        

#line default
#line hidden
#nullable disable
#nullable restore
#line 78 "D:\My Projects\C# Git\AirShare\Controls\Explorer.razor"
         if(Path == null){
            try
            {        
                string q = new Uri(NavMan.Uri).Query.ToString().TrimStart('?');       
                Path = Uri.UnescapeDataString(q.TrimStart('?')).Trim('"');        
            }
            catch (Exception ex)
            {
                //TODO: Use more understandable err msgs
                Console.WriteLine("Path error " + ex.Message);
                msg = "Path error " + ex.Message;
                Path = "\\";
                
            }
        }

#line default
#line hidden
#nullable disable
#nullable restore
#line 92 "D:\My Projects\C# Git\AirShare\Controls\Explorer.razor"
         

        usr = Userdata.Auth();
        if(usr == null)
        {
            msg = "Please wait...";
            authed = false;
           
            return;
        }

        LoadDir();

    }

    string LoadedPath = "`";
    void LoadDir()
    {
        if(LoadedPath == Path)
        {
            return;
        }
        LoadedPath = Path;



        if(usr != null && usr.Validate(Path))
        {
            authed = true;
        }
        else
        {
            authed = false;
            return;
        }

        


        try
        {
            DE = FSService.ListFiles(Path);
        }
        catch (Exception ex)
        {
            Console.WriteLine("Explore error " + Path + " >> " + ex.Message);
            DE = new DirectoryEntries();
            msg = "Cannot load path";
            Failed = true;

            Core.Log(msg + $"\t {Userdata.Token}");
            
        }

        StateHasChanged();
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {

        }

       // string QPath;
        try
        {        
            string q = new Uri(NavMan.Uri).Query.ToString().TrimStart('?');       
            Path = Uri.UnescapeDataString(q.TrimStart('?')).Trim('"');        
        }
        catch (Exception )
        {
            
        }

        

        LoadDir();

        if(!authed)
        {
            NavMan.NavigateTo("/?" + Uri.EscapeDataString(Path), true);
        }
    }


    public void Navigate(string name)
    {
       NavigateAbs(System.IO.Path.Combine(DE.Path, name));
    }
    public void NavigateAbs(string path)
    {
        Path = path;
        NavMan.NavigateTo("explorer?" + Uri.EscapeDataString(path), false);
        LoadDir();
        StateHasChanged();
    }

    public void NavigateBack()
    {
        NavigateAbs(FSService.ParentDir(Path));
    }

    public void NavigateText()
    {
        NavigateAbs(FSService.NavigateText(Path));
    }

    public void NavigateFile(FSEntry fse)
    {
        string fp = Uri.EscapeDataString(System.IO.Path.Combine(DE.Path, fse.Name));
        string ename = Uri.EscapeDataString(fse.Name);

        if(fse.CheckIs(FSFileAttrib.Document | FSFileAttrib.Image))
        {
            NavMan.NavigateTo($"OpenStream/{ename}?" + fp, true);
        }
        else if(fse.CheckIs(FSFileAttrib.Video))
        {
            NavMan.NavigateTo($"PlayVideo/{ename}?" + fp, true);
        }
        else if(fse.CheckIs(FSFileAttrib.Audio))
        {
            NavMan.NavigateTo($"PlayAudio/{ename}?" + fp, true);
        }
        else if(fse.CheckIs(FSFileAttrib.Text))
        {
            //TODO : OpenText
            NavMan.NavigateTo($"OpenStream/{ename}?" + fp, true);
        }
        else
        {
             OpenInNewTab($"OpenFile/{ename}?" + fp);
        }

    }

    public async void OpenInNewTab(string Path)
    {
        await JSRuntime.InvokeVoidAsync("OpenNew", Path);
    }

#line default
#line hidden
#nullable disable
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private UserData Userdata { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private Microsoft.JSInterop.IJSRuntime JSRuntime { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private Microsoft.AspNetCore.Components.NavigationManager NavMan { get; set; }
    }
}
#pragma warning restore 1591
